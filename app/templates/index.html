<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Riddle</title>
    <!-- Add the favicon link here -->
    <link rel="icon" href="{{ url_for('static', filename='emojiriddlewebicon.png') }}" type="image/png">
    <!-- Existing CSS links -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Define color variables */
        :root {
            --bg-color: #ffffff;
            --text-color: #212529;
            --card-bg: #ffffff;
            --card-border: #dee2e6;
            --tile-bg: #f8f9fa;
            --tile-border: #ced4da;
            --tile-text: #495057;
            --tile-disabled-bg: #e9ecef;
            --tile-disabled-text: #6c757d;
            --tile-correct-bg: #90ee90; /* Light green */
            --tile-correct-border: #5cb85c;
            --tile-correct-text: #333;
            --muted-text: #6c757d;
            --link-color: #0d6efd;
            --alert-info-bg: #cfe2ff;
            --alert-info-text: #084298;
            /* Add other alert colors if needed */
        }

        body.dark-mode {
            --bg-color: #212529;
            --text-color: #f8f9fa;
            --card-bg: #343a40;
            --card-border: #495057;
            --tile-bg: #495057;
            --tile-border: #6c757d;
            --tile-text: #f8f9fa;
            --tile-disabled-bg: #343a40;
            --tile-disabled-text: #6c757d;
            --tile-correct-bg: #2e6a2e; /* Darker green */
            --tile-correct-border: #3a8a3a;
            --tile-correct-text: #e9ecef;
            --muted-text: #adb5bd;
            --link-color: #6ea8fe;
            --alert-info-bg: #031633;
            --alert-info-text: #6ea8fe;
            /* Add other alert colors if needed */
        }

        /* Apply variables */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s; /* Smooth transition */
        }

        .card {
            background-color: var(--card-bg);
            border-color: var(--card-border);
        }

        .card-body {
             color: var(--text-color); /* Ensure text inside card uses theme color */
        }

        .answer-tile {
            border-bottom: 3px solid var(--tile-border);
            color: var(--text-color); /* Ensure revealed letters use theme color */
            /* ... other answer-tile styles ... */
        }
        .answer-tile.space {
             border-bottom: none;
        }


        .letter-tile {
            background-color: var(--tile-bg);
            border: 1px solid var(--tile-border);
            color: var(--tile-text);
            /* ... other letter-tile styles ... */
        }

        .letter-tile.disabled {
            background-color: var(--tile-disabled-bg);
            color: var(--tile-disabled-text);
            cursor: default;
            opacity: 0.7;
        }

         .letter-tile.correct {
            background-color: var(--tile-correct-bg);
            border-color: var(--tile-correct-border);
            color: var(--tile-correct-text);
        }

        .guesses-left, .category-display, .text-muted {
            color: var(--muted-text) !important; /* Use important if Bootstrap overrides */
        }

        a {
            color: var(--link-color);
        }

        /* Update alert styles if needed */
        .alert-info { /* Example for info */
             color: var(--alert-info-text);
             background-color: var(--alert-info-bg);
             border-color: var(--alert-info-bg); /* Adjust border as needed */
        }
        /* Add rules for .alert-success, .alert-danger etc. if you use them */


        /* Style for the toggle button */
        #darkModeToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1050; /* Ensure it's above most elements */
        }

        /* ... rest of your existing styles ... */
        .emoji-display { 
            font-size: 5rem; 
            text-align: center; 
            margin-bottom: 10px; 
            /* Add this line to prevent selection */
            user-select: none; /* Standard */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
        }
        .category-display { text-align: center; color: #6c757d; margin-bottom: 20px; font-style: italic;}
        .container { max-width: 600px; margin-top: 50px; }
        .answer-tiles {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 30px;
            min-height: 50px;
            flex-wrap: wrap; /* Allow wrapping for longer answers */
        }
        .answer-tile {
            border-bottom: 3px solid #ccc;
            width: 35px;
            height: 45px;
            display: inline-flex;
            justify-content: center;
            align-items: flex-end; /* Align letter to bottom */
            font-size: 1.8rem;
            font-weight: bold;
            text-transform: uppercase;
            padding-bottom: 2px;
        }
        .answer-tile.space {
            border-bottom: none; /* No line for spaces */
        }
        .alphabet-tiles {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .letter-tile {
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            text-decoration: none;
            color: #333;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        .letter-tile:hover {
            background-color: #e2e6ea;
        }
        .letter-tile.disabled {
            background-color: #d3d3d3;
            color: #888;
            pointer-events: none; /* Make it unclickable */
            border-color: #bbb;
        }
        /* Add style for correctly guessed letters */
        .letter-tile.correct {
            background-color: #90ee90; /* Light green */
            border-color: #5cb85c;
            color: #333; /* Ensure text is still readable */
        }
        .guesses-left {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button id="darkModeToggle" class="btn btn-secondary btn-sm">ðŸŒ™</button>

    <div class="container">
        <h1 class="text-center mb-4">Guess the Emoji Name!</h1>

        <!-- Countdown Timer Display -->
        <div id="countdownTimer" class="text-center text-muted mb-3" style="font-size: 0.9rem;">
            Next Emojile in: <span id="timerDisplay">--:--:--</span>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if riddle_id is not none %} {# Check if we have a riddle ID #}
            <div class="card">
                <div class="card-body">
                    <!-- Emoji Display (Initially Empty) -->
                    <!-- Add data-riddle-id attribute -->
                    <div class="emoji-display" data-riddle-id="{{ riddle_id }}">&nbsp;</div>
                    <!-- Display Category -->
                    <div class="category-display">
                        Category: {{ category }}
                    </div>

                    <!-- Guesses Left Display -->
                    <div class="guesses-left">
                        Guesses Left: {{ max_guesses - incorrect_guesses }} / {{ max_guesses }}
                    </div>
                    <!-- End Guesses Left Display -->

                    <!-- Answer Display (Uses emoji name passed as answer_display) -->
                    <div class="answer-tiles">
                        {% for char in answer_display %}
                            {% if char.isalpha() %}
                                <span class="answer-tile">
                                    {{ char.upper() if (char in guessed_letters or game_over) else '&nbsp;' | safe }}
                                </span>
                            {% elif char == ' ' %}
                                <span class="answer-tile space">&nbsp;</span>
                            {% else %}
                                {# Display other characters like hyphens directly #}
                                <span class="answer-tile">{{ char }}</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <!-- End Answer Display -->

                    <!-- Alphabet Tiles -->
                    <div class="alphabet-tiles">
                        {% for letter in alphabet %}
                            {% set letter_lower = letter.lower() %}
                            {% set is_guessed = letter_lower in guessed_letters %}
                            {# Check against the name (answer_display) #}
                            {% set is_correct = is_guessed and letter_lower in answer_display %}

                            <a href="{{ url_for('main.index', guess=letter_lower) if not game_over else '#' }}"
                               id="tile-{{ letter_lower }}"
                               class="letter-tile
                                      {{ 'correct' if is_correct else '' }}
                                      {{ 'disabled' if is_guessed or game_over else '' }}">
                                {{ letter }}
                            </a>
                        {% endfor %}
                    </div>
                    <!-- End Alphabet Tiles -->

                </div>
            </div>
        {% else %}
            <div class="alert alert-warning" role="alert">
                No riddle available today, or database is empty. Please check back tomorrow or run 'flask init-db'.
            </div>
        {% endif %}

        <!-- Stats Display -->
        {% if stats.total_games > 0 %} {# Only show stats if at least one game played #}
        <div class="card mt-4">
            <div class="card-header">
                Your Statistics
                {% if streak_test_mode %}
                    <span class="badge bg-warning text-dark float-end">Streak Test Mode Active</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Total Games Played:</strong> {{ stats.total_games }}</p>
                        <p><strong>Average Incorrect Guesses:</strong> {{ "%.2f"|format(avg_incorrect) }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Current Daily Play Streak:</strong> {{ stats.current_play_streak }}</p>
                        <p><strong>Longest Daily Play Streak:</strong> {{ stats.longest_play_streak }}</p>
                        <p><strong>Current Correct Guess Streak:</strong> {{ stats.current_correct_streak }}</p>
                        <p><strong>Longest Correct Guess Streak:</strong> {{ stats.longest_correct_streak }}</p>
                    </div>
                </div>
                 {% if stats.last_played_date_str %}
                 <small class="text-muted">Last game finished: {{ stats.last_played_date_str }}</small>
                 {% endif %}
                 {% if stats.last_played_datetime_str %}
                 <small class="text-muted">Last game finished: {{ stats.last_played_datetime_str }}</small>
                 {% endif %}
            </div>
        </div>
        {% endif %}
        <!-- End Stats Display -->

        <footer class="text-center mt-4 text-muted py-3"> <!-- Added py-3 for padding -->
            &copy; {{ current_year }} Emojile
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Pass the next midnight time from Flask to JavaScript
        const nextMidnightISO = "{{ next_midnight_iso | default('null') }}"; // Use default filter for safety

        document.addEventListener('DOMContentLoaded', () => {
            const emojiDisplay = document.querySelector('.emoji-display');
            const riddleId = emojiDisplay ? emojiDisplay.getAttribute('data-riddle-id') : null;
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            const timerDisplayElement = document.getElementById('timerDisplay');
            const countdownContainer = document.getElementById('countdownTimer');

            // --- Countdown Timer Logic ---
            let timerInterval = null;

            function updateCountdown() {
                if (!nextMidnightISO || nextMidnightISO === 'null' || !timerDisplayElement) {
                    if(countdownContainer) countdownContainer.style.display = 'none'; // Hide if no time
                    return; // Exit if no target time or element
                }

                const targetTime = new Date(nextMidnightISO).getTime();
                const now = new Date().getTime();
                const difference = targetTime - now;

                if (difference <= 0) {
                    // Time is up or passed
                    timerDisplayElement.textContent = "Ready!";
                    if(countdownContainer) countdownContainer.innerHTML = "<strong>New Emojile available!</strong> Refresh the page.";
                    clearInterval(timerInterval); // Stop the timer
                } else {
                    // Calculate hours, minutes, seconds
                    const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((difference % (1000 * 60)) / 1000);

                    // Format H:MM:SS
                    timerDisplayElement.textContent =
                        `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if(countdownContainer) countdownContainer.style.display = 'block'; // Ensure visible
                }
            }

            // Initial call and set interval
            if (nextMidnightISO && nextMidnightISO !== 'null') {
                 updateCountdown(); // Run once immediately
                 timerInterval = setInterval(updateCountdown, 1000); // Update every second
            } else {
                 if(countdownContainer) countdownContainer.style.display = 'none'; // Hide if no time initially
            }
            // --- End Countdown Timer Logic ---


            // --- Dark Mode Logic ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    darkModeToggle.textContent = 'â˜€ï¸'; // Sun icon for light mode
                } else {
                    body.classList.remove('dark-mode');
                    darkModeToggle.textContent = 'ðŸŒ™'; // Moon icon for dark mode
                }
            };

            // Check localStorage for saved theme
            const savedTheme = localStorage.getItem('theme') || 'light'; // Default to light
            applyTheme(savedTheme);

            // Toggle button event listener
            darkModeToggle.addEventListener('click', () => {
                const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme); // Save preference
                applyTheme(newTheme);
            });
            // --- End Dark Mode Logic ---


            // --- Emoji Fetch Logic ---
            if (emojiDisplay && riddleId) {
                fetch(`/api/get-emoji/${riddleId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.emoji) {
                            emojiDisplay.textContent = data.emoji;
                        } else {
                            console.error("Failed to load emoji:", data.error || "Unknown error");
                            emojiDisplay.textContent = '?';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching emoji:', error);
                        emojiDisplay.textContent = '?';
                    });
            }
            // --- End Emoji Fetch Logic ---

            // --- Existing Keyboard Listener ---
            document.addEventListener('keydown', (event) => {
                const key = event.key.toLowerCase();
                if (key.length === 1 && key >= 'a' && key <= 'z') {
                    const tile = document.getElementById(`tile-${key}`);
                    if (tile && !tile.classList.contains('disabled')) {
                        // Simulate click or directly navigate
                        window.location.href = tile.href;
                    }
                }
            });
            // --- End Keyboard Listener ---
        });
    </script>
</body>
</html>